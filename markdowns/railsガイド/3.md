- カラムの作成または変更時に、カラムの修飾子を適用できます。
- limit - string/text/binary/integerフィールドの最大サイズを設定します。
- precision - decimalフィールドの精度 (precision) を定義します。この精度は、その数字の総桁数で表されます。
- scale - decimalフィールドの精度 (スケール: scale) を指定します。この精度は小数点以下の桁数で表されます。
- polymorphic - belongs_to関連付けで使用するtypeカラムを追加します。
- null - カラムでNULL値を許可または禁止します。
- default - カラムでのデフォルト値の設定を許可します。
- dateなどの動的な値を使用している場合は、デフォルト値は最初 (マイグレーションが実行された日付など) にしか計算されないことに注意してください。
- index - カラムにインデックスを追加します。
- 3.6 外部キー
- 参照整合性の保証 に対して外部キー制約を追加することもできます。これは必須ではありません。

`add_foreign_key :articles, :authors`
- 上によって新たな外部キーがarticlesテーブルのauthor_idカラムに追加されます。
- このキーはauthorsテーブルのidカラムを参照します。
- 欲しいカラム名をテーブル名から類推できない場合は、:columnオプションと:primary_keyオプションを使用できます。

- Railsでは、すべての外部キーはfk_rails_という名前で始まり、その後ろに10文字のランダムな文字列が続きます。
- 必要であれば、:nameオプションを指定することで別の名前を使用できます。

- Active Recordでは単一カラムの外部キーのみがサポートされています。複合外部キーを使用する場合はexecuteとstructure.sqlが必要です。
- 3.8 changeメソッドを使用する
- changeメソッドは、マイグレーションを自作する場合に最もよく使用されます。
- このメソッドを使用すれば、Active Recordがマイグレーションを逆方向に実行 (ロールバック) する方法を自動的に理解してくれるため、多くの場面で使用できます。
- 現時点では、changeでサポートされているマイグレーション定義は以下のものだけです。

- add_column
- add_index
- add_reference
- add_timestamps
- add_foreign_key
- create_table
- create_join_table
- drop_table (ブロックを渡す必要あり)
- drop_join_table (ブロックを渡す必要あり)
- remove_timestamps
- rename_column
- rename_index
- remove_reference
- rename_table
- change_tableの逆転は、change、change_default、removeが呼び出されない限り可能です。

- これ以外のメソッドを使用する必要が生じた場合は、changeメソッドではなくreversibleメソッドを利用するか、upとdownメソッドを明示的に書くようにしてください。
- 4.2 データベースを設定する
- `bin/rails db:setup`タスクは、データベースの作成、スキーマの読み込み、シードデータを使用したデータベースの初期化を実行します。

- 4.3 データベースをリセットする
- `bin/rails db:reset`タスクは、データベースを`drop`して再度設定します。このタスクは、`bin/rails db:drop db:setup`と同等です。

- このタスクは、すべてのマイグレーションを実行することと等価ではありません。
- このタスクでは現在のschema.rbの内容をそのまま使い回しているためです。
- マイグレーションをロールバックできなくなった場合には、`bin/rails db:reset`を実行しても復旧できないことがあります。
- スキーマダンプの詳細については、スキーマダンプの意義 セクションを参照してください。
- 4.5 異なる環境でマイグレーションを実行する
- デフォルトでは、`bin/rails db:migrate`はdevelopment環境で実行されます。
- 他の環境に対してマイグレーションを行いたい場合は、コマンド実行時にRAILS_ENV環境変数を指定します。
- たとえば、test環境でマイグレーションを実行する場合は以下のようにします。

- `$ bin/rails db:migrate RAILS_ENV=test`
- 5 既存のマイグレーションを変更する
- マイグレーションを自作していると、ときにはミスしてしまうこともあります。
- いったんマイグレーションを実行してしまった後では、既存のマイグレーションを単に編集してもう一度マイグレーションをやり直しても意味がありません。
- Railsはマイグレーションが既に実行済みであると認識しているので、`bin/rails db:migrate`を実行しても何も変更されません。
- このような場合には、マイグレーションをいったんロールバック (bin/rails db:rollbackなど) してからマイグレーションを修正し、それから修正の完了したバージョンのマイグレーションを実行するためにbin/rails db:migrateを実行する必要があります。

- そもそも、既存のマイグレーションを直接変更するのは一般的によい方法とは言えません。
- 既存のマイグレーションを変更すると、自分どころか共同作業者にまで余分な作業を強いることになります。
- さらに、既存のマイグレーションが本番環境で実行中の場合、ひどい頭痛の種になるでしょう。
- 既存のマイグレーションを直接修正するのではなく、そのためのマイグレーションを新たに作成してそれを実行するのが正しい方法です。
- これまでコミットされてない (より一般的に言えば、これまでdevelopment環境以外に展開されたことのない) マイグレーションを新たに生成し、それを編集するのが害の少ない方法であると言えます。
- 6.2 スキーマダンプの種類
- スキーマのダンプ方法は2種類あります。
-
- ダンプ方法はconfig/application.rbのconfig.active_record.schema_formatで設定します。:sqlまたは:rubyを指定できます。

- :rubyを指定すると、スキーマはdb/schema.rbに保存されます。
- このファイルを開いてみると、1つの巨大なマイグレーションのように見えるはずです。

```ruby
ActiveRecord::Schema.define(version: 20080906171750) do
  create_table "authors", force: true do |t|
    t.string   "name"
    t.datetime "created_at"
    t.datetime "updated_at"
  end

  create_table "products", force: true do |t|
    t.string   "name"
    t.text "description"
    t.datetime "created_at"
    t.datetime "updated_at"
    t.string "part_number"
  end
end
```

- このスキーマ情報は、見てのとおりその内容を単刀直入に表しています。
- このファイルは、データベースを詳細に検査し、create_tableやadd_indexなどでその構造を表現することによって作成されています。
- このスキーマ情報はデータベースの種類に依存しないため、Active Recordがサポートしているデータベースであればどんなものにでも読み込むことができます。
- この特性は、複数の種類のデータベースを実行できるアプリケーションを展開する必要がある場合に特に有用です。
- このような有用な特性を得られる代りに、1つの代償があります。
- 当然ながら、db/schema.rbにはデータベース固有の項目 (トリガーやストアドプロシージャなど) を含めることはできません。
- マイグレーションにはカスタムSQLを含めることはできますが、スキーマをダンプするときにデータベースからこの構文を再構成することはできないのです。
- データベース固有の機能を使用するのであれば、スキーマのフォーマットを:sqlにする必要があります。

- この場合、Active Recordのスキーマダンプを使用する代りに、データベース固有のツールを使用してデータベースの構造をdb/structure.sqlにダンプします (db:structure:dump Rakeタスクを使用します)。
- たとえばPostgreSQLの場合はpg_dumpユーティリティが使用されます。
- MySQLの場合は、多くのテーブルにおいてSHOW CREATE TABLEの出力結果がファイルに含まれます。

- これらのスキーマの読み込みは、そこに含まれるSQL文を実行するだけの非常にシンプルなものです。
- 定義上、これによってデータベース構造の完全なコピーが作成されます。その代わり、:sqlスキーマフォーマットを使用した場合は、そのスキーマを作成したRDBMS以外では読み込めないという制限が生じます
